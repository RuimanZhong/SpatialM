colnames(area.sf)<-c('value.a','geometry')
a = dwscaler.spde (mesh,area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01),
p.sf,area.sf)
locin= st_join(p.sf,area.sf,left = F)
locin_pred = st_join(area.pre,area.sf,left = F)
#Projection Matrix for point data and target area
if(is.null(mesh) ==T){
mesh = Mesh(bd.sf,max.edge = c(0.7, 0.7),cut.off = 0.25,offset = c(-0.05, -0.05))
message("Generate mesh by default")
}
Ap = inla.spde.make.A(mesh, loc = as.matrix(st_coordinates(p.sf[,1]))[,c(1,2)])
Apre = inla.spde.make.A(mesh = mesh, loc = as.matrix (st_coordinates(area.pre[,1])))
View(locin)
a = dwscaler.spde (mesh,area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01),
p.sf,area.sf)
source('dwscalerv2.R')
a = dwscaler.spde (mesh,area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01),
p.sf,area.sf)
View(a)
formula = y ~ 0 + b0 + f(s, model = spde)
check_meld(area.sf, p.sf,area.pre,proN)
st_crs(area.sf) <- proN
if(is.null(area.sf)== F && st_crs(area.sf) != proN)
stop("The crs of 'area.sf' is not 'proN'")
st_crs(area.sf)
crs = st_crs(area.sf)
View(crs)
area.sf =st_as_sf(spol)
st_crs(area.sf) <- proN
st_transform (area.sf) <- proN
st_transform (area.sf,proN)
spol<-rasterToPolygons(ra, dissolve = F)
area.sf =st_as_sf(spol)
st_transform(area.sf,proN)
st_transform(area.sf,4326)
st_join(area.sf,area.pre)
source('check.r')
source('mesh.R')
source('meld.v2.R')
area.pre = area.pre(pre.sf,cell.x,cell.y,proN =4326)
source('tarConstr.R')
area.pre = area.pre(pre.sf,cell.x,cell.y,proN =4326)
st_crs(area.sf) != st_crs(area.pre)
st_crs(p.sf) != st_crs(area.pre)
check_meld(area.sf, p.sf,area.pre,proN)
colnames(area.sf)<-c('value.a','geometry')
View(bd.sf)
bd.sf <- geoboundaries("United Kingdom")
st_transform(area.sf,27700)
pre.sf = bd.sf
area.pre = area.pre(pre.sf,cell.x,cell.y,proN =27700)
source('tarConstr.R')
source('tarConstr.R')
area.pre = area.pre(pre.sf,cell.x,cell.y,proN =27700)
a = dwscaler.spde (mesh,area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01),
p.sf,area.sf)
p.sf = p.df %>%
st_as_sf(coords = c("px", "py"), dim = "XY") %>%
st_set_crs(proN) %>%
st_cast("MULTIPOINT")
st_join(p.sf, area.sf, left = F)
View(area.sf)
st_transform(area.sf,27700)
a = dwscaler.spde (mesh,area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01),
p.sf,area.sf)
st_transform(area.sf,27700)
area.sf = st_transform(area.sf,27700)
area.sf
p.sf
st_join(p.sf, area.sf, left = F)
ggplot(data = p.sf$geometry)+geom_sf()
area.sf =st_as_sf(spol)
area.sf
p.sf = p.df %>%
st_as_sf(coords = c("px", "py"), dim = "XY") %>%
st_set_crs(4326) %>%
st_cast("MULTIPOINT")
p.sf
area.sf
st_transform(area.sf,4326)
a = dwscaler.spde (mesh,area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01),
p.sf,area.sf)
colnames(area.sf)<-c('value.a','geometry')
a = dwscaler.spde (mesh,area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01),
p.sf,area.sf)
st_transform(area.sf,proN)
st_transform(bd.sf,proN)
proN = 4326
st_transform(bd.sf,proN)
area.pre = area.pre(pre.sf,cell.x,cell.y,proN =proN)
source('tarConstr.R')
area.pre = area.pre(pre.sf,cell.x,cell.y,proN =proN)
a = dwscaler.spde (mesh,area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01),
p.sf,area.sf)
b=meld(formula,mesh,p.sf = p.sf,area.pre = area.pre,prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
mesh = Mesh(bd.sf,max.edge,cut.off = 0.25,offset)
b=meld(formula,mesh,p.sf = p.sf,area.pre = area.pre,prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
Ap = inla.spde.make.A(mesh, as.matrix(st_coordinates(p.sf[,1]))[,c(1,2)])
Ap = inla.spde.make.A(mesh, as.matrix(st_coordinates(p.sf[,1]))[,c(1,2)])
b=meld(formula =formula,mesh = mesh,p.sf = p.sf,area.pre = area.pre,prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
spde = inla.spde2.pcmatern(
mesh = mesh,
prior.range = prior.range,
prior.sigma = prior.sigma)
stk.p <- inla.stack(tag='point',
data=list(y=p.sf$value.p),
A=list(Ap, 1),effects=list(s=1:spde$n.spde, data.frame(b0 =rep(1, length(p.sf$value.p)))))
Ap  =NULL
Aa = NULL
stk.p <- inla.stack(tag='point',
data=list(y=p.sf$value.p),
A=list(Ap, 1),effects=list(s=1:spde$n.spde, data.frame(b0 =rep(1, length(p.sf$value.p)))))
p.sf = NULL
stk.p <- inla.stack(tag='point',
data=list(y=p.sf$value.p),
A=list(Ap, 1),effects=list(s=1:spde$n.spde, data.frame(b0 =rep(1, length(p.sf$value.p)))))
p.sf$value.p
source('meld_v3.R')
b=meld(formula =formula,mesh = mesh,p.sf = NULL,area.pre = area.pre,prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
b=meld(formula =formula,mesh = mesh,p.sf = p.sf,area.pre = area.pre,prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
p.sf = p.df %>%
st_as_sf(coords = c("px", "py"), dim = "XY") %>%
st_set_crs(proN) %>%
st_cast("MULTIPOINT")
b=meld(formula =formula,mesh = mesh,p.sf = p.sf,area.pre = area.pre,prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
source('meld_v3.R')
source('geosp.R')
source('meld_v3.R')
b=meld(formula =formula,mesh = mesh,p.sf = p.sf,area.pre = area.pre,prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
View(b)
b_2 = meld(formula =formula,mesh = mesh,p.sf = NULL,area.sf= are.sf,
area.pre = area.pre,prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
b_2 = meld(formula =formula,mesh = mesh,p.sf = NULL,area.sf= area.sf,
area.pre = area.pre,prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
source('meld_v3.R')
b_2 = meld(formula =formula,mesh = mesh,p.sf = NULL,area.sf= area.sf,
area.pre = area.pre,prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
source('meld_v3.R')
b_2 = meld(formula =formula,mesh = mesh,p.sf = NULL,area.sf= area.sf,
area.pre = area.pre,prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
p.sf = area.sf
# Projection Matrix
Ap = inla.spde.make.A(mesh, as.matrix(st_coordinates(p.sf[,1]))[,c(1,2)])
Apre = inla.spde.make.A(mesh = mesh, loc = as.matrix (st_coordinates(area.pre[,1])))
#construct SPDE
spde = inla.spde2.pcmatern(
mesh = mesh,
prior.range = prior.range,
prior.sigma = prior.sigma)
# construct stack
indexs = inla.spde.make.index("s", spde$n.spde)
b_2 = meld(formula =formula,mesh = mesh,p.sf = NULL,area.sf= area.sf,
area.pre = area.pre,prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
source('meld_v3.R')
colnames(p.df)<-c('value','py','px')
p.sf = p.df %>%
st_as_sf(coords = c("px", "py"), dim = "XY") %>%
st_set_crs(proN) %>%
st_cast("MULTIPOINT")
colnames(area.sf)<-c('value','geometry')
source('meld_v3.R')
source('check.r')
source('check.r')
source('dwscalerv2.R')
source('tarConstr.R')
source('meld_v3.R')
p.sf = area.sf
# Projection Matrix
Ap = inla.spde.make.A(mesh, as.matrix(st_coordinates(p.sf[,1]))[,c(1,2)])
Apre = inla.spde.make.A(mesh = mesh, loc = as.matrix (st_coordinates(area.pre[,1])))
area.pre = area.pre(pre.sf,cell.x,cell.y,proN =proN)
Apre = inla.spde.make.A(mesh = mesh, loc = as.matrix (st_coordinates(area.pre[,1])))
dim(Ap)
dim(Apre)
#construct SPDE
spde = inla.spde2.pcmatern(
mesh = mesh,
prior.range = prior.range,
prior.sigma = prior.sigma)
# construct stack
indexs = inla.spde.make.index("s", spde$n.spde)
p.sf = area.sf
colnames(p.sf)<-c('value','geometry')
View(p.sf)
stk.e <- inla.stack(
tag = "est",
data = list(y = p.sf$value),
A = list(1, Ap),
effects = list(data.frame(b0 = rep(1, nrow(p.sf))), s = indexs)
)
stk.a <- inla.stack(tag= 'areal',data=list(y=area.sf$value.a),
A=list(Aa, 1),effects=list(s=1:spde$n.spde,
data.frame(b0 =rep(1, length(area.sf$value.a)))))
View(area.sf)
stk.a <- inla.stack(tag= 'areal',data=list(y=area.sf$value.a),
A=list(Aa, 1),effects=list(s=1:spde$n.spde,
data.frame(b0 =rep(1, length(area.sf$value.a)))))
st_rook = function(a, b = a) st_relate(a, b, pattern = "F***1****")
st_rook(grd)
nc %>% mutate(NB_ROOK = st_rook(.))
sf::nc
install.packages("spdep")
library(spdep)
nc %>% mutate(NB_ROOK = st_rook(.))
data(nc)
nc <- st_read(system.file("shapes/sids.shp", package="spData")[1], quiet=TRUE)
st_crs(nc) <- "+proj=longlat +datum=NAD27"
row.names(nc) <- as.character(nc$FIPSNO)
class(nc)
nc %>% mutate(NB_ROOK = st_rook(.))
demo(nc, ask = FALSE, verbose = FALSE)
nc %>% mutate(NB_ROOK = st_rook(.))
View(nc)
area.sf %>% mutate(NB_ROOK = st_rook(.))
ncovr_rook <- st_rook(ncovr)
source('areal.R')
source('meld_v3.R')
source('geosp.R')
source('mesh.R')
source('areal.R')
source('check.r')
packages = c('raster','rgdal',
'rnaturalearth',
'viridis','rnaturalearthhires','sf','INLA','rgeoboundaries','tidyverse')
package.check = lapply(packages, FUN =function(x){
if(!require(x ,character.only = T))
install.packages(x)
if(!(x %in% ( .packages()  ) ) )
library(x ,character.only = T)})
setwd("~/Documents/Project 1/resources/sptialM")
source('mesh.R')
source('check.r')
source('dwscalerv2.R')
source('tarConstr.R')
source('meld_v3.R')
setwd("~/Documents/Project 1/resources/sptialM")
source('mesh.R')
source('mesh.R')
source('check.r')
source('dwscalerv2.R')
source('tarConstr.R')
source('meld_v3.R')
bd.sf <- geoboundaries("United Kingdom")
pre.sf = bd.sf
cutoff = 0.25
max.edge = c(0.7, 0.7)
offset = c(-0.05, -0.05)
prior.range = c(2, 0.01)
prior.sigma = c(10, 0.01)
proN = 4326
cell.x = 50
cell.y =50
# point data, load the data when wd is on data
setwd("~/Documents/Project 1/data")
st_transform(bd.sf,proN)
p.df <- read.csv("2016PM2.5_avg.csv")
p.df = p.df[,c(2,3,4)]
colnames(p.df)<-c('value.p','py','px')
p.sf = p.df %>%
st_as_sf(coords = c("px", "py"), dim = "XY") %>%
st_set_crs(proN) %>%
st_cast("MULTIPOINT")
# area data, load the data when wd is on data
str_name<-'area_2016_pm2.5/gwr_pm25_2016.tif'
glo_pm = raster(str_name)
rr <- mask(crop(glo_pm, bd.sf), bd.sf)
fa = 30
ra <- raster:: aggregate(rr, fact = fa, fun = mean)
spol<-rasterToPolygons(ra, dissolve = F)
area.sf =st_as_sf(spol)
area.sf = st_transform(area.sf,proN)
colnames(area.sf)<-c('value.a','geometry')
ggplot(data = p.sf$geometry)+geom_sf()
mesh = Mesh(bd.sf,max.edge,cut.off = 0.25,offset)
plot(mesh)
a = dwscaler.spde (mesh, area.pre,
prior.range = c(2, 0.01),
prior.sigma = c(10, 0.01),
p.sf, area.sf)
p.sf = p.df %>%
st_as_sf(coords = c("px", "py"), dim = "XY") %>%
st_set_crs(proN) %>%
st_cast("MULTIPOINT")
a = dwscaler.spde (mesh, area.pre,
prior.range = c(2, 0.01),
prior.sigma = c(10, 0.01),
p.sf, area.sf)
area.pre = area.pre(pre.sf, cell.x, cell.y, proN = proN)
a = dwscaler.spde (mesh, area.pre,
prior.range = c(2, 0.01),
prior.sigma = c(10, 0.01),
p.sf, area.sf)
formula = y ~ 0 + b0 + f(s, model = spde)
b_1=meld(formula =formula, mesh = mesh,
p.sf = p.sf, area.pre = area.pre,
prior.range = c(2, 0.01), prior.sigma = c(10, 0.01))
b_2 = meld(formula =formula,
mesh = mesh, p.sf = NULL,
area.sf= area.sf,
area.pre = area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
View(area.pre)
View(area.sf)
b_2 = meld(formula =formula,
mesh = mesh, p.sf = NULL,
area.sf = area.sf,
area.pre = area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
message(class(area.pre))
b_2 = meld(formula =formula,
mesh = mesh, p.sf = NULL,
area.sf = area.sf,
area.pre = area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
b_2 = meld(formula =formula,
mesh = mesh, p.sf = NULL,
area.sf = area.sf,
area.pre = area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
locin_pred = st_join(area.pre, area.sf, left = F)
b_2 = meld(formula =formula,
mesh = mesh, p.sf = NULL,
area.sf = area.sf,
area.pre = area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
source('meld_v3.R')
setwd("~/Documents/Project 1/resources/sptialM")
source('meld_v3.R')
b_2 = meld(formula =formula,
mesh = mesh, p.sf = NULL,
area.sf = area.sf,
area.pre = area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
b_2 = meld(formula =formula,
mesh = mesh, p.sf = NULL,
area.sf = area.sf,
area.pre = area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
b_2 = meld(formula =formula,
mesh = mesh, p.sf = NULL,
area.sf = area.sf,
area.pre = area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
source('meld_v3.R')
source('meld_v3.R')
b_2 = meld(formula =formula,
mesh = mesh, p.sf = NULL,
area.sf = area.sf,
area.pre = area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
source('meld_v3.R')
b_2 = meld(formula =formula,
mesh = mesh, p.sf = NULL,
area.sf = area.sf,
area.pre = area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
source('meld_v3.R')
b_2 = meld(formula =formula,
mesh = mesh, p.sf = NULL,
area.sf = area.sf,
area.pre = area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
locin_pred = st_join(area.pre, area.sf, left = F)
# Projection Matrix
meshcoo = data.frame(long = mesh$loc[,1], lat = mesh$loc[,2] )
meshin = meshcoo %>%
st_as_sf(coords = c("long", "lat"), dim = "XY") %>%
st_set_crs(proN) %>%
st_cast("MULTIPOINT")
# find points in mesh n area.sf
locin = st_join(meshin, area.sf, left = F)
Aa = inla.spde.make.A (mesh = mesh,
loc = as.matrix(st_coordinates(locin[,1]))[,c(1,2)]
)
Apred = inla.spde.make.A (mesh = mesh,
loc = as.matrix (st_coordinates(area.pre[,1])
)
)
dim(Aa)
dim(Apre)
dim(Apred)
stk.a = inla.stack( tag= 'areal',
data=list(y=area.sf$value.a),
A=list(Aa, 1),effects=list( s=1:spde$n.spde,
data.frame(b0 =rep(1, length(area.sf$value.a)
)
)
)
)
spde = inla.spde2.pcmatern(
mesh = mesh,
prior.range = prior.range,
prior.sigma = prior.sigma)
stk.a = inla.stack( tag= 'areal',
data=list(y=area.sf$value.a),
A=list(Aa, 1),effects=list( s=1:spde$n.spde,
data.frame(b0 =rep(1, length(area.sf$value.a)
)
)
)
)
stk.pred = inla.stack( tag= 'pred',
data=list(y=NA),
A=list(Apred, 1),
effects=list(s=1:spde$n.spde,
data.frame(b0 =rep(1, nrow(locin_pred)
)
)
)
)
stk.a = inla.stack( tag= 'areal',
data=list(y=area.sf$value.a),
A=list(Aa, 1),effects=list( s=1:spde$n.spde,
data.frame(b0 =rep(1, length(area.sf$value.a)
)
)
)
)
View(locin)
mesh = Mesh(bd.sf, max.edge, cut.off = 0.1, offset)
plot(mesh)
# find points in mesh n area.sf
locin = st_join(meshin, area.sf, left = F)
# Projection Matrix
meshcoo = data.frame(long = mesh$loc[,1], lat = mesh$loc[,2] )
meshin = meshcoo %>%
st_as_sf(coords = c("long", "lat"), dim = "XY") %>%
st_set_crs(proN) %>%
st_cast("MULTIPOINT")
# find points in mesh n area.sf
locin = st_join(meshin, area.sf, left = F)
Aa = inla.spde.make.A (mesh = mesh,
loc = as.matrix(st_coordinates(locin[,1]))[,c(1,2)]
)
Apred = inla.spde.make.A (mesh = mesh,
loc = as.matrix (st_coordinates(area.pre[,1])
)
)
dim(Aa)
dim(Apred)
spde$n.spde
stk.a = inla.stack( tag= 'areal',
data=list(y=area.sf$value.a),
A=list(Aa, 1),effects=list( s=1:spde$n.spde,
data.frame(b0 =rep(1, length(locin$value.a)
)
)
)
)
stk.a = inla.stack( tag= 'areal',
data=list(y=area.sf$value.a),
A=list(Aa, 1),effects=list( s=1:spde$n.spde,
data.frame(b0 =rep(1, length(area.sf$value.a)
)
)
)
)
stk.a = inla.stack( tag= 'areal',
data=list(y=locin$value.a),
A=list(Aa, 1),effects=list( s=1:spde$n.spde,
data.frame(b0 =rep(1, length(locin$value.a)
)
)
)
)
stk.pred = inla.stack( tag= 'pred',
data=list(y=NA),
A=list(Apred, 1),
effects=list(s=1:spde$n.spde,
data.frame(b0 =rep(1, nrow(locin_pred)
)
)
)
)
inla.stack(stk.a, stk.pred)
c = meld(mesh,area.pre,
p.sf,area.sf,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01),proN)
c = meld(formula =formula,
mesh = mesh, area.pre = area.pre,
p.sf = p.sf,area.sf = area.sf,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01),proN = proN)
stk.full = stack.full.areal(Aa,Apred,area.sf,locin_pred,spde)
source('meld_v3.R')
stk.full = stack.full.areal(Aa,Apred,area.sf,locin_pred,spde)
res = inla ( formula,
data = inla.stack.data(stk.full),
control.predictor = list(
compute = TRUE,
A = inla.stack.A(stk.full)
)
)
b_2 = meld(formula =formula,
mesh = mesh, p.sf = NULL,
area.sf = area.sf,
area.pre = area.pre,
prior.range = c(2, 0.01),prior.sigma = c(10, 0.01))
setwd("~/Documents/Project 1/resources/sptialM")
class(mesh)
devtools::document()
install.packages("devtools")
devtools::document()
library(devtools)
document()
